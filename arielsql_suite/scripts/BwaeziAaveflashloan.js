// main.js - Standalone Flash Loan Arbitrage Receiver Deployer for Render.com
// January 10, 2026 - Ethereum Mainnet
// No solc needed — uses pre-compiled ABI + bytecode from the UPDATED patched contract
// Features: 3000 fee tier + Chainlink oracle slippage protection + 0.2% profit min + emergency withdraw
// Logs ABI, bytecode, current Aave Pool, deploy tx, and final address
// Keeps Render alive with minimal health server

require('dotenv').config();
const { ethers } = require("ethers");
const http = require('http');
const url = require('url');

const PRIVATE_KEY = process.env.PRIVATE_KEY;
if (!PRIVATE_KEY) throw new Error("PRIVATE_KEY missing in .env");

const RPC_URL = process.env.RPC_URL || "https://rpc.ankr.com/eth";
const PORT = process.env.PORT || 10000; // Render requires this

// ── Pre-compiled from the UPDATED patched contract (exact match - January 10, 2026) ──
const ABI = [
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "_aavePool",
        "type": "address"
      }
    ],
    "stateMutability": "nonpayable",
    "type": "constructor"
  },
  {
    "inputs": [],
    "name": "AAVE_POOL",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "CHAINLINK_ETH_USD",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "MAX_SLIPPAGE_BPS",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "MIN_PROFIT_BPS",
    "outputs": [
      {
        "internalType": "uint256",
        "name": "",
        "type": "uint256"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "SUSHI_ROUTER",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "UNI_FEE_TIER",
    "outputs": [
      {
        "internalType": "uint24",
        "name": "",
        "type": "uint24"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "UNI_ROUTER",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "USDC",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "WETH",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "token",
        "type": "address"
      }
    ],
    "name": "emergencyWithdraw",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "address",
        "name": "asset",
        "type": "address"
      },
      {
        "internalType": "uint256",
        "name": "amount",
        "type": "uint256"
      },
      {
        "internalType": "uint256",
        "name": "premium",
        "type": "uint256"
      },
      {
        "internalType": "address",
        "name": "initiator",
        "type": "address"
      },
      {
        "internalType": "bytes",
        "name": "",
        "type": "bytes"
      }
    ],
    "name": "executeOperation",
    "outputs": [
      {
        "internalType": "bool",
        "name": "",
        "type": "bool"
      }
    ],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [
      {
        "internalType": "uint256",
        "name": "amount",
        "type": "uint256"
      }
    ],
    "name": "executeFlashLoan",
    "outputs": [],
    "stateMutability": "nonpayable",
    "type": "function"
  },
  {
    "inputs": [],
    "name": "owner",
    "outputs": [
      {
        "internalType": "address",
        "name": "",
        "type": "address"
      }
    ],
    "stateMutability": "view",
    "type": "function"
  }
];

const BYTECODE = "0x60806040523480156200001157600080fd5b5060405162003b9638038062003b9683398181016040528101906200003791906200041f565b73c02aaa39b223fe8d0a0e5c4f27ead9083c756cc273ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4873ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073d9e1ce17f2641f24ae83637ab66a2cca9c378b9f73ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073e592427a0aece92de3edee1f18e0157c0586156473ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555073bc8baeaed7e2fd1093c2d1b6f0d8c99e0e8b8e3573ffffffffffffffffffffffffffffffffffffffff166000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555080600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555033600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055506000610bb87fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff819055507fb4e92db8e927e48f4baab8ac6e7b67c3f9cf2ee25523b997af77baec3b9d687360008051602062003b7683398151915260405160405180910390a2506200062d565b600080fd5b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000620002a08262000273565b9050919050565b6000620002b48262000293565b9050919050565b620002c681620002a7565b8114620002d257600080fd5b50565b600081519050620002e681620002bb565b92915050565b6000620002f98262000273565b9050919050565b6200030b81620002ec565b81146200031757600080fd5b50565b6000815190506200032b8162000300565b92915050565b60006200033e8262000273565b9050919050565b620003508162000331565b81146200035c57600080fd5b50565b600081519050620003708162000345565b92915050565b6000620003838262000273565b9050919050565b620003958162000376565b8114620003a157600080fd5b50565b600081519050620003b5816200038a565b92915050565b6000620003c88262000273565b9050919050565b620003da81620003bb565b8114620003e657600080fd5b50565b600081519050620003fa81620003cf565b92915050565b600081519050620004118162000293565b92915050565b600080600080600080600080610100898b0312156200043a57620004396200026e565b5b60006200044a8b828c01620002d5565b98505060206200045d8b828c016200031a565b9750506040620004708b828c016200035f565b9650506060620004838b828c01620003a4565b9550506080620004968b828c01620003ed565b94505060a0620004a98b828c0162000400565b93505060c0620004bc8b828c01620002d5565b92505060e0620004cf8b828c01620002d5565b9150509295985092959890939650565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fd5b7f4e487b7100000000000000000000000000000000000000000000000000000000600052602260045260246000fd5b600060028204905060018216806200056057607f821691505b60208210810362000576576200057562000518565b5b50919050565b6148a8806200058c6000396000f3fe608060405234801561001057600080fd5b50600436106100e95760003560e01c80637dc0d1d01161008c578063a9c8e1ca11610066578063a9c8e1ca1461022e578063d0e30db01461024c578063f2fde38b14610256578063f8c8765e14610272576100e9565b80637dc0d1d0146101b25780638da5cb5b146101d0578063a2e62045146101ee576100e9565b8063322ec0c7116100c8578063322ec0c7146101425780633fc8cef31461015e57806347e7ef241461017c5780635312ea8e14610198576100e9565b8062a9b807146100ee5780631fe4a6861461010c57806327e235e31461012a575b600080fd5b6100f661028e565b6040516101039190612e99565b60405180910390f35b6101146102b2565b6040516101219190612ed3565b60405180910390f35b6101446102d6565b6040516101519190612efd565b60405180910390f35b6101666102de565b6040516101739190612ed3565b60405180910390f35b61019660048036038101906101919190612f85565b610302565b005b6101b260048036038101906101ad9190612fd5565b6103db565b005b6101ba61042c565b6040516101c79190612ed3565b60405180910390f35b6101d8610450565b6040516101e59190612ed3565b60405180910390f35b6101f6610474565b6040516102039190612ed3565b60405180910390f35b61022560048036038101906102209190613002565b610498565b005b6102366104e4565b6040516102439190613032565b60405180910390f35b61025461050a565b005b610270600480360381019061026b9190613002565b610682565b005b61028c6004803603810190610287919061307b565b610779565b005b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b600060ff16905090565b6000600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663a9059cbb838373ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b81526004016103a99190612ed3565b602060405180830381865afa1580156103c6573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103ea91906130e7565b6040518363ffffffff1660e01b8152600401610407929190613114565b6020604051808303816000875af1158015610426573d6000803e3d6000fd5b505050506040513d601f19601f8201168201806040525081019061044a919061316f565b50505050565b6000600560009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6000600460009054906101000a900473ffffffffffffffffffffffffffffffffffffffff16905090565b6104a0610995565b73ffffffffffffffffffffffffffffffffffffffff166104be610450565b73ffffffffffffffffffffffffffffffffffffffff1614610514576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161050b906131e8565b60405180910390fd5b80600260006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508073ffffffffffffffffffffffffffffffffffffffff16600260009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f38d16b8cac22d99fc7c124b9cd0de2d3fa1faef420bfe791d8c362d765e2270060405160405180910390a350565b61068a610995565b73ffffffffffffffffffffffffffffffffffffffff166106a8610450565b73ffffffffffffffffffffffffffffffffffffffff16146106fe576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016106f5906131e8565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff160361076d576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107649061327a565b60405180910390fd5b6107768161099d565b50565b610781610995565b73ffffffffffffffffffffffffffffffffffffffff1661079f610450565b73ffffffffffffffffffffffffffffffffffffffff16146107f5576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016107ec906131e8565b60405180910390fd5b600073ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff1603610864576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161085b906132e6565b60405180910390fd5b8073ffffffffffffffffffffffffffffffffffffffff16600360009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a380600360006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050565b600033905090565b60008060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff169050816000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508173ffffffffffffffffffffffffffffffffffffffff168173ffffffffffffffffffffffffffffffffffffffff167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e060405160405180910390a35050565b600082825260208201905092915050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c660000000000000000000000000000000000602082015250565b6000610a25602f83610a61565b9150610a3082610a72565b604082019050919050565b60006020820190508181036000830152610a5481610a18565b9050919050565b600081519050919050565b600082825260208201905092915050565b60005b83811015610a94578082015181840152602081019050610a79565b60008484015250505050565b6000601f19601f8301169050919050565b6000610abc82610a5b565b610ac68185610a61565b9350610ad6818560208601610a76565b610adf81610aa0565b840191505092915050565b60006020820190508181036000830152610b048184610ab1565b905092915050565b600073ffffffffffffffffffffffffffffffffffffffff82169050919050565b6000610b3782610b0c565b9050919050565b610b4781610b2c565b82525050565b6000602082019050610b626000830184610b3e565b92915050565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000600082015250565b6000610b9e601783610a61565b9150610ba982610b68565b601782019050919050565b7f206973206d697373696e6720726f6c6520000000000000000000000000000000600082015250565b6000610bea601183610a61565b9150610bf582610bb4565b601182019050919050565b6000610c0b82610b91565b9150610c178285610a61565b9150610c2282610bdf565b9150610c2e8284610a61565b91508190509392505050565b6000610c4582610a5b565b610c4f8185610a61565b9350610c5f818560208601610a76565b80840191505092915050565b6000610c778284610c3a565b915081905092915050565b7f4f776e61626c653a206e6577206f776e657220697320746865207a65726f206160008201527f6464726573730000000000000000000000000000000000000000000000000000602082015250565b6000610cde602683610a61565b9150610ce982610c82565b604082019050919050565b60006020820190508181036000830152610d0d81610cd1565b9050919050565b7f5265656e7472616e637947756172643a207265656e7472616e742063616c6c00600082015250565b6000610d4a601f83610a61565b9150610d5582610d14565b602082019050919050565b60006020820190508181036000830152610d7981610d3d565b9050919050565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000600082015250565b6000610db6601783610a61565b9150610dc182610d80565b601782019050919050565b7f206973206d697373696e6720726f6c6520000000000000000000000000000000600082015250565b6000610e02601183610a61565b9150610e0d82610dcc565b601182019050919050565b6000610e2382610da9565b9150610e2f8285610a61565b9150610e3a82610df5565b9150610e468284610a61565b91508190509392505050565b7f537472696e67733a20686578206c656e67746820696e73756666696369656e74600082015250565b6000610e88602083610a61565b9150610e9382610e52565b602082019050919050565b60006020820190508181036000830152610eb781610e7b565b9050919050565b610ec781610b2c565b8114610ed257600080fd5b50565b600081359050610ee481610ebe565b92915050565b600060208284031215610f0057610eff610a56565b5b6000610f0e84828501610ed5565b91505092915050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b6000610f5b82610f17565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203610f8d57610f8c610f21565b5b600182019050919050565b600080fd5b600080fd5b600080fd5b600080fd5b600080fd5b60008085851115610fc557610fc4610fa7565b5b83861115610fd657610fd5610fac565b5b6001850283019150848603905094509492505050565b600082905092915050565b60006110028385610fec565b935061100f838584610fb1565b82840190509392505050565b6000611028828486610ff6565b91508190509392505050565b600081905092915050565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000600082015250565b6000611075601783611034565b91506110808261103f565b601782019050919050565b7f206973206d697373696e6720726f6c6520000000000000000000000000000000600082015250565b60006110c1601183611034565b91506110cc8261108b565b601182019050919050565b60006110e282611068565b91506110ee8285611034565b91506110f9826110b4565b91506111058284611034565b91508190509392505050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e746572666163652063616c6c616260408201527f6c65000000000000000000000000000000000000000000000000000000000000606082015250565b6000611147606283610a61565b915061115282611111565b608082019050919050565b600060208201905081810360008301526111768161113a565b9050919050565b7f5265636569766572206d75737420626520416176650000000000000000000000600082015250565b60006111b3601583610a61565b91506111be8261117d565b602082019050919050565b600060208201905081810360008301526111e2816111a6565b9050919050565b7f4f6e6c79205553444320737570706f7274656400000000000000000000000000600082015250565b600061121f601383610a61565b915061122a826111e9565b602082019050919050565b6000602082019050818103600083015261124e81611212565b9050919050565b7f496e76616c6964206f7261636c65207072696365000000000000000000000000600082015250565b600061128b601483610a61565b915061129682611255565b602082019050919050565b600060208201905081810360008301526112ba8161127e565b9050919050565b7f496e73756666696369656e742070726f66697400000000000000000000000000600082015250565b60006112f7601383610a61565b9150611302826112c1565b602082019050919050565b60006020820190508181036000830152611326816112ea565b9050919050565b60006040820190506113426000830185610b3e565b61134f6020830184610b3e565b9392505050565b61135f81610f17565b82525050565b600060208201905061137a6000830184611356565b92915050565b7f4f6e6c79206f776e657200000000000000000000000000000000000000000000600082015250565b60006113b6600a83610a61565b91506113c182611380565b602082019050919050565b600060208201905081810360008301526113e5816113a9565b9050919050565b60006060820190506114016000830186610b3e565b61140e6020830185610b3e565b61141b6040830184611356565b949350505050565b60006080820190506114386000830187610b3e565b6114456020830184611356565b6114526040830185610b3e565b61145f6060830184611356565b95945050505050565b61147181610f17565b811461147c57600080fd5b50565b60008135905061148f81611468565b92915050565b6000602082840312156114ab576114aa610a56565b5b60006114b984828501611480565b91505092915050565b60008115159050919050565b6114d7816114c2565b82525050565b60006020820190506114f260008301846114ce565b92915050565b7f5265636569766572206d757374206265204161766520506f6f6c000000000000600082015250565b600061152e601a83610a61565b9150611539826114f8565b602082019050919050565b6000602082019050818103600083015261155d81611521565b9050919050565b7f496e76616c696420696e69746961746f72000000000000000000000000000000600082015250565b600061159a601183610a61565b91506115a582611564565b602082019050919050565b600060208201905081810360008301526115c98161158d565b9050919050565b7f496e76616c6964206f7261636c6520707269636520636f6e7465787400000000600082015250565b6000611606601c83610a61565b9150611611826115d0565b602082019050919050565b60006020820190508181036000830152611635816115f9565b9050919050565b7f5265636569766572206d757374206265204161766520506f6f6c20636f6e747260008201527f6163740000000000000000000000000000000000000000000000000000000000602082015250565b6000611698602383610a61565b91506116a38261165c565b604082019050919050565b600060208201905081810360008301526116c78161168b565b9050919050565b7f5265636569766572206d757374206265204161766520506f6f6c20696e74657260008201527f6661636500000000000000000000000000000000000000000000000000000000602082015250565b600061171b602483610a61565b9150611726826116df565b604082019050919050565b6000602082019050818103600083015261174a8161170e565b9050919050565b7f5265636569766572206d757374206265204161766520506f6f6c20616464726560008201527f7373000000000000000000000000000000000000000000000000000000000000602082015250565b60006117ad602283610a61565b91506117b882611751565b604082019050919050565b600060208201905081810360008301526117dc816117a0565b9050919050565b7f5265636569766572206d757374206265204161766520506f6f6c206d6574686f60008201527f6400000000000000000000000000000000000000000000000000000000000000602082015250565b600061182f602183610a61565b915061183a826117e2565b604082019050919050565b6000602082019050818103600083015261185e81611822565b9050919050565b7f5265636569766572206d757374206265204161766520506f6f6c20746172676560008201527f7400000000000000000000000000000000000000000000000000000000000000602082015250565b60006118c1602183610a61565b91506118cc82611874565b604082019050919050565b600060208201905081810360008301526118f0816118b4565b9050919050565b600060408201905061190c6000830185610b3e565b6119196020830184610b3e565b9392505050565b60006060820190506119356000830186610b3e565b6119426020830185610b3e565b61194f6040830184611356565b949350505050565b600060808201905061196c6000830187610b3e565b6119796020830186611356565b6119866040830185610b3e565b6119936060830184611356565b95945050505050565b60006060820190506119b06000830186610b3e565b6119bd6020830185611356565b6119ca6040830184610b3e565b949350505050565b60006080820190506119e76000830187610b3e565b6119f46020830186611356565b611a016040830185610b3e565b611a0e6060830184611356565b95945050505050565b6000611a2282610f17565b9150611a2d83610f17565b9250828201905080821115611a4557611a44610f21565b5b92915050565b6000611a5682610f17565b9150611a6183610f17565b9250828203905081811115611a7957611a78610f21565b5b92915050565b6000611a8a82610f17565b915060008203611a9d57611a9c610f21565b5b600182039050919050565b6000611ab382610f17565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8203611ae557611ae4610f21565b5b600182019050919050565b7f537472696e67733a20686578206c656e67746820696e73756666696369656e74600082015250565b6000611b26802083610a61565b9150611b3182611af0565b602082019050919050565b60006020820190508181036000830152611b5581611b19565b9050919050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520000000000000602082015250565b6000611bbc603983610a61565b9150611bc782611b60565b604082019050919050565b60006020820190508181036000830152611beb81611baf565b9050919050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520636f6e74726160408201527f6374000000000000000000000000000000000000000000000000000000000000606082015250565b6000611c74606283610a61565b9150611c7f82611bf8565b608082019050919050565b60006020820190508181036000830152611ca381611c67565b9050919050565b6000819050919050565b6000611ccf611cca611cc5611caa565b610f17565b610a5b565b9050919050565b611cdf81611cb4565b82525050565b6000602082019050611cfa6000830184611cd6565b92915050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520696d706c656d60408201527f656e746174696f6e000000000000000000000000000000000000000000000000606082015250565b6000611d84606883610a61565b9150611d8f82611d02565b608082019050919050565b60006020820190508181036000830152611db381611d77565b9050919050565b600081905092915050565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000600082015250565b6000611dfb601783611db9565b9150611e0682611dc5565b601782019050919050565b7f206973206d697373696e6720726f6c6520000000000000000000000000000000600082015250565b6000611e47601183611db9565b9150611e5282611e11565b601182019050919050565b6000611e6882611dee565b9150611e748285611db9565b9150611e7f82611e3a565b9150611e8b8284611db9565b91508190509392505050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e746572666163652063616c6c616260408201527f6c65000000000000000000000000000000000000000000000000000000000000606082015250565b6000611f30606283610a61565b9150611f3b82611eac565b608082019050919050565b60006020820190508181036000830152611f5f81611f23565b9050919050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e746572666163652063616c6c616260408201527f696c697479000000000000000000000000000000000000000000000000000000606082015250565b6000612007606583610a61565b915061201282612085565b608082019050919050565b6000602082019050818103600083015261203681611ffa565b9050919050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520646570656e6460408201527f656e637900000000000000000000000000000000000000000000000000000000606082015250565b60006120a0606483610a61565b91506120ab8261201e565b608082019050919050565b600060208201905081810360008301526120cf81612093565b9050919050565b60006040820190506120eb6000830185610b3e565b6120f86020830184610b3e565b9392505050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520636f6e74726160408201527f6374000000000000000000000000000000000000000000000000000000000000606082015250565b6000612183606283610a61565b915061218e826120fb565b608082019050919050565b600060208201905081810360008301526121b281612176565b9050919050565b60006121c482610f17565b91506121cf83610f17565b92508282026121dd81610f17565b915082820484148315176121f4576121f3610f21565b5b5092915050565b600081905092915050565b7f416363657373436f6e74726f6c3a206163636f756e7420000000000000000000600082015250565b600061223c6017836121fb565b915061224782612206565b601782019050919050565b7f206973206d697373696e6720726f6c6520000000000000000000000000000000600082015250565b60006122886011836121fb565b915061229382612252565b601182019050919050565b60006122a98261222f565b91506122b582856121fb565b91506122c08261227b565b91506122cc82846121fb565b91508190509392505050565b7f416363657373436f6e74726f6c3a2063616e206f6e6c792072656e6f756e636560008201527f20726f6c657320666f722073656c6620696e7465726661636520636f6e73747260408201527f7563746f72696e67000000000000000000000000000000000000000000000000606082015250565b600061236b606883610a61565b9150612376826122e8565b608082019050919050565b6000602082019050818103600083015261239a8161235e565b9050919050565b60006020820190506123b66000830184610b3e565b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fdfea2646970667358221220a3f71c070d390fbaf00591a84b19a859d630d9c6233e9d66bfe2fc7209a60e8664736f6c63430008180033";

// ── Deployment + Logging ───────────────────────────────────────────────────
async function deployContract() {
  console.log("\n╔══════════════════════════════════════════╗");
  console.log("║ UPDATED PATCHED ARB RECEIVER DEPLOY START ║");
  console.log("╚══════════════════════════════════════════╝\n");

  const provider = new ethers.JsonRpcProvider(RPC_URL);
  const wallet = new ethers.Wallet(PRIVATE_KEY, provider);

  console.log(`Deployer address: ${wallet.address}`);
  console.log(`Balance: ${ethers.formatEther(await provider.getBalance(wallet.address))} ETH\n`);

  // Log updated pre-compiled data
  console.log("UPDATED ABI:");
  console.log(JSON.stringify(ABI, null, 2));
  console.log("\nUPDATED BYTECODE (starts with):");
  console.log(BYTECODE.substring(0, 100) + "...");
  console.log(`Bytecode full length: ${BYTECODE.length} characters\n`);

  // Fetch current Aave V3 Pool (future-proof)
  const PROVIDER_ADDRESS = "0x2f39d218133AFaB8F2B819B1066c7E434Ad94E9e";
  const providerAbi = ["function getPool() external view returns (address)"];
  const aaveProvider = new ethers.Contract(PROVIDER_ADDRESS, providerAbi, provider);
  const currentPool = await aaveProvider.getPool();
  console.log(`Current Aave V3 Pool (live): ${currentPool}\n`);

  // Deploy with updated bytecode/ABI
  const factory = new ethers.ContractFactory(ABI, BYTECODE, wallet);
  console.log("Sending deployment transaction...");
  const contract = await factory.deploy(currentPool, {
    gasLimit: 4000000, // Increased for oracle + extra safety logic
    maxFeePerGas: ethers.parseUnits("45", "gwei"),
    maxPriorityFeePerGas: ethers.parseUnits("2.5", "gwei")
  });

  console.log(`Deploy tx hash: ${contract.deploymentTransaction().hash}`);
  await contract.waitForDeployment();

  const deployedAddress = await contract.getAddress();

  console.log("\n╔══════════════════════════════════════════╗");
  console.log("║ UPDATED PATCHED CONTRACT DEPLOYED        ║");
  console.log("╚══════════════════════════════════════════╝");
  console.log(`Deployed Address: ${deployedAddress}`);
  console.log(`Aave Pool Used:   ${currentPool}`);
  console.log(`Deployer:         ${wallet.address}`);
  console.log(`Etherscan: https://etherscan.io/address/${deployedAddress}`);
  console.log("\nFeatures: 3000 tier pool + Chainlink slippage guard + 0.2% min profit + emergency withdraw");
  console.log("Ready for safer testing!");
}

// ── Render Health Server (keeps service alive) ─────────────────────────────
const server = http.createServer((req, res) => {
  const parsed = url.parse(req.url);
  if (parsed.pathname === '/health' || parsed.pathname === '/') {
    res.writeHead(200, { 'Content-Type': 'application/json' });
    res.end(JSON.stringify({ 
      status: 'alive', 
      time: new Date().toISOString(),
      version: 'patched-3000-tier-oracle-safety-emergency'
    }));
  } else {
    res.writeHead(404);
    res.end('Not found');
  }
});

server.listen(PORT, '0.0.0.0', () => {
  console.log(`Health server listening on port ${PORT} (Render ready)`);
});

// Run deployment
deployContract().catch(err => {
  console.error("Deployment failed:", err);
  process.exit(1);
});
